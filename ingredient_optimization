
import pandas as pd
import matplotlib.pyplot as plt
import re

# Load ingredient matrix
ingredient_df = pd.read_csv("dataset/MSY Data - Ingredient.csv")
ingredient_df.columns = ingredient_df.columns.str.strip()
ingredient_df['Item name'] = ingredient_df['Item name'].str.strip().str.lower()

print("Ingredient matrix loaded:", ingredient_df.shape)
print(ingredient_df.head(3))


# Load monthly data
def load_month_data(file_path, sheet_name, month_name):
    print(f"\n--- Loading month: {month_name} ---")
    df = pd.read_excel(file_path, sheet_name=sheet_name)
    item_col = next((col for col in df.columns if 'item' in col.lower()), None)
    amount_col = next((col for col in df.columns if 'amount' in col.lower()), None)
    if not item_col or not amount_col:
        print(f"Missing columns in {month_name}")
        return None

    # Clean and convert amount column
    df[amount_col] = pd.to_numeric(df[amount_col].replace('[\$,]', '', regex=True), errors='coerce')
    df = df[df[amount_col].notna() & (df[amount_col] != 0)]
    df = df[[item_col, amount_col]].rename(columns={item_col: 'Item Name', amount_col: 'Amount'})
    df['Month'] = month_name
    df['Item Name'] = df['Item Name'].str.strip().str.lower()
    print(f"{month_name} loaded with {len(df)} rows")
    return df


files = [
    ("dataset/May_Data_Matrix (1).xlsx", "data 3", "May"),
    ("dataset/June_Data_Matrix.xlsx", "data 3", "June"),
    ("dataset/July_Data_Matrix (1).xlsx", "data 3", "July"),
    ("dataset/August_Data_Matrix (1).xlsx", "data 3", "August"),
    ("dataset/September_Data_Matrix.xlsx", "data 3", "September"),
    ("dataset/October_Data_Matrix_20251103_214000.xlsx", "data 2", "October"),
]

monthly_dfs = [load_month_data(f, s, m) for f, s, m in files if load_month_data(f, s, m) is not None]
combined_df = pd.concat(monthly_dfs, ignore_index=True)
print("\nCombined monthly data shape:", combined_df.shape)
print(combined_df.head(5))


#special matching cases
special_matches = {
    "fried wings": ["chicken wings", "fried chicken", "crunch chicken"],
    "chicken cutlet": ["chicken cutlet"],
    "beef tossed rice noodles": ["beef tossed rice noodle"],
    "pork tossed rice noodles": ["pork tossed rice noodle"],
    "chicken tossed rice noodles": ["chicken tossed rice noodle"]
}


# Clean and format ingredient labels
def clean_label(label):
    label = re.sub(r'\s*\([^)]*\)', '', label)  #remove units
    label = label.strip().title()               #capitalize each word
    return label


# Compute profit per ingredient per month
ingredient_profit_per_month = {month: {} for month in combined_df['Month'].unique()}
month_total_profit = {}

for month in combined_df['Month'].unique():
    month_df = combined_df[combined_df['Month'] == month]
    month_total = month_df['Amount'].sum()
    month_total_profit[month] = month_total
    print(f"\nCalculating profits for {month} ({len(month_df)} rows, total profit = ${month_total:,.2f})")

    for ingredient in ingredient_df.columns[1:]:
        ingredient_clean = ingredient.strip()
        used_in_items = ingredient_df.loc[
            ingredient_df[ingredient].notna() & (ingredient_df[ingredient] != 0),
            'Item name'
        ].dropna().tolist()

        total_profit = 0.0

        for item in used_in_items:
            patterns = special_matches.get(item, [item])
            for p in patterns:
                matched = month_df[month_df['Item Name'].str.contains(p, case=False, na=False)]
                if not matched.empty:
                    profit = matched['Amount'].sum()
                    total_profit += profit

        ingredient_profit_per_month[month][ingredient_clean] = total_profit


# Plot one graph per month (PERCENTAGES)
for month, profits in ingredient_profit_per_month.items():
    df_plot = pd.DataFrame(list(profits.items()), columns=['Ingredient', 'Total Profit'])
    df_plot['Ingredient'] = df_plot['Ingredient'].apply(clean_label)

    # Compute percentage of total monthly profit
    total_profit = month_total_profit[month]
    df_plot['Percentage'] = (df_plot['Total Profit'] / total_profit) * 100
    df_plot = df_plot.sort_values(by='Percentage', ascending=False)

    plt.figure(figsize=(12, 8))
    plt.barh(df_plot['Ingredient'], df_plot['Percentage'])
    plt.xlabel('Contribution to Total Monthly Profit (%)')
    plt.ylabel('Ingredient')
    plt.title(f'Ingredient Profit Contribution as % of Total Monthly Profit â€” {month}')
    plt.xlim(0, 100)
    plt.gca().invert_yaxis()
    plt.tight_layout()
    plt.show()

