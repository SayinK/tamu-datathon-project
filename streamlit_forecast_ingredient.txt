import streamlit as st
import pandas as pd
import altair as alt

# PAGE CONFIGURATION
st.set_page_config(layout="wide", page_title="Ingredient Demand Forecast Viewer")

# Configuration
CSV_FILEPATH = "ingredient_forecast_fixed.csv"
HISTORICAL_MONTHS = 6 # Assuming May through October are the historical proxy points


# DATA LOADING AND PREPROCESSING
@st.cache_data
def load_data():
    #loads, cleans, and pre-processes the ingredient forecast data.
    try:
        df = pd.read_csv(CSV_FILEPATH)

        df = df.rename(columns={
            'Date' : 'ds',
            'Forecasted_Usage' : 'yhat',
            'Ingredient' : 'ingredient'
        })
       
        df = df.drop(columns=['Month_Label'])

        # Convert date column to datetime objects
        df['ds'] = pd.to_datetime(df['ds'])

        # Determine the period for visualization
        df['period'] = df.groupby('ingredient').cumcount()
        df['period'] = df['period'].apply(lambda x: 'Historical Proxy' if x < HISTORICAL_MONTHS else 'Future Forecast')
        
        return df
    except FileNotFoundError:
        st.error(f"Error: The file '{CSV_FILEPATH}' was not found. Please ensure it is uploaded.")
        return pd.DataFrame()
    except Exception as e:
        st.error(f"Error loading or processing data: {e}")
        return pd.DataFrame()


# CHART GENERATION FUNCTIONS
def create_trend_chart(df, ingredient_name):
    """Creates the interactive time series Altair chart for a single ingredient."""
    df_filtered = df[df['ingredient'] == ingredient_name].sort_values('ds')
    
    # Base chart setup
    base = alt.Chart(df_filtered).encode(
        x=alt.X('ds', title='Date', axis=alt.Axis(format="%b %Y")),
        y=alt.Y('yhat', title=f'Forecasted Quantity ({ingredient_name.split("(")[-1].replace(")", "")})', scale=alt.Scale(zero=False)),
        tooltip=[
            alt.Tooltip('ds', title='Date', format='%Y-%m-%d'),
            alt.Tooltip('yhat', title='Quantity', format=',.0f'),
            'period'
        ]
    )

    # Line showing the trend, colored by period (Historical vs Future)
    line = base.mark_line(point=True).encode(
        color=alt.Color('period', 
                        scale=alt.Scale(domain=['Historical Proxy', 'Future Forecast'], 
                                        range=['#10b981', '#ef4444']),
                        legend=alt.Legend(title="Forecast Period")),
        strokeWidth=alt.value(3)
    )
    
    # Add a rule/line for the transition point
    transition_df = df_filtered[df_filtered['period'] == 'Future Forecast']
    if not transition_df.empty:
        transition_date = transition_df['ds'].min()
        rule = alt.Chart(pd.DataFrame({'date': [transition_date]})).mark_rule(
            strokeDash=[5, 5], 
            color='gray',
            size=1
        ).encode(
            x='date'
        )
        chart = rule + line
    else:
        chart = line

    return chart.properties(
        title=f'Demand Forecast Trend: {ingredient_name}'
    ).interactive()


def calculate_metrics(df_filtered):
   #Calculates key metrics for the selected ingredient
    if df_filtered.empty:
        return None

    historical_data = df_filtered[df_filtered['period'] == 'Historical Proxy']
    forecast_data = df_filtered[df_filtered['period'] == 'Future Forecast']
    
    metrics = {}
    
    # Historical Metrics
    metrics['Historical Average'] = historical_data['yhat'].mean()
    metrics['Historical Peak'] = historical_data['yhat'].max()
    
    # Forecast Metrics (using the last forecast point)
    if not forecast_data.empty:
        last_forecast = forecast_data.iloc[-1]
        metrics['Dec 2025 Forecast'] = last_forecast['yhat']
        
        # Calculate Percentage Change (Last Historical vs. Last Forecast)
        if not historical_data.empty:
            last_historical = historical_data.iloc[-1]['yhat']
            change = ((last_forecast['yhat'] - last_historical) / last_historical) * 100
            metrics['% Change (Last Hist to Dec 2025)'] = change

    return metrics



# STREAMLIT APP LAYOUT
if __name__ == "__main__":
    df = load_data()

    st.title("ðŸœ Ingredient Demand Forecast Dashboard")
    st.markdown("Select an ingredient below to view its historical proxy data and future demand forecast trend!")

    if not df.empty:
        # Ingredient Selection (The Dropdown) 
        default_ingredient = 'Rice(g)' if 'Rice(g)' in df['ingredient'].unique() else df['ingredient'].iloc[0]
        
        selected_ingredient = st.selectbox(
            "**Select Ingredient to Analyze:**", 
            df['ingredient'].unique().tolist(),
            index=df['ingredient'].unique().tolist().index(default_ingredient) if default_ingredient in df['ingredient'].unique() else 0
        )

        st.markdown("---")
        
        # Main Chart 
        if selected_ingredient:
            trend_chart = create_trend_chart(df, selected_ingredient)
            st.altair_chart(trend_chart, use_container_width=True)

            # Metrics Summary 
            metrics_df = df[df['ingredient'] == selected_ingredient]
            metrics = calculate_metrics(metrics_df)
            
            st.subheader("Ingredient Order Summary")
            
            if metrics:
                col1, col2, col3, col4 = st.columns(4)
                
                # Historical Average
                col1.metric(
                    label="Historical Proxy Avg.", 
                    value=f"{metrics.get('Historical Average', 0):,.0f}"
                )

                # Historical Peak
                col2.metric(
                    label="Historical Proxy Peak", 
                    value=f"{metrics.get('Historical Peak', 0):,.0f}"
                )

                # Dec 2025 Forecast
                forecast_value = metrics.get('Dec 2025 Forecast')
                col3.metric(
                    label="Dec 2025 Forecast", 
                    value=f"{forecast_value:,.0f}" if forecast_value is not None else "N/A"
                )

                # Percentage Change
                change_value = metrics.get('% Change (Last Hist to Dec 2025)')
                col4.metric(
                    label="% Change (since Last Historical)", 
                    value=f"{change_value:.2f}%" if change_value is not None else "N/A",
                    delta_color="normal"
                )
            
            st.markdown("---")
            st.subheader("Raw Data Points")
            st.dataframe(metrics_df[['ds', 'yhat', 'period']].rename(
                columns={'ds': 'Date', 'yhat': 'Forecast Quantity', 'period': 'Period'}), 
                use_container_width=True
            )

    elif df.empty:
        st.warning("Data could not be loaded. Please ensure the CSV file is correctly formatted and available.")
    else:
        st.info("The loaded data set appears to be empty or missing sufficient ingredient information to perform the analysis.")